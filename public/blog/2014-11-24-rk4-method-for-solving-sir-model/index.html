<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1">

  
  
  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
  

  
  <title>RK4 Method for Solving SIR Model</title>

  
  
  <link rel="stylesheet" href="http://blog.tonytsai.name/css/hugo-octopress.css">

  
  

  
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">

  
  <link href="http://blog.tonytsai.name/favicon.png" rel="icon">

  
  
  

  

  <meta name="description" content="">
  <meta name="keywords" content="">

  <meta name="author" content="Tony Tsai">

  
  <meta name="generator" content="Hugo 0.18.1" />

  
  
<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-40665800-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>


</head>
<body>


<header role="banner"><hgroup>
  
  <h1><a href="http://blog.tonytsai.name/">Tony Tsai</a></h1>
    <h2>May the force of science be with you</h2>
</hgroup></header>


<nav role="navigation">

<ul class="main-navigation">
  
  
    
      <li><a href="http://blog.tonytsai.name/" title="Blog">Blog</a></li>
    
  
    
      <li><a href="http://tonytsai.name/cv.pdf" title="Resume"  target="_blank" >Resume</a></li>
    
  
    
      <li><a href="http://blog.tonytsai.name/douban/" title="Douban"  target="_blank" >Douban</a></li>
    
  
    
      <li><a href="http://blog.tonytsai.name/archive/" title="Archive"  target="_blank" >Archive</a></li>
    
  
</ul>


<ul class="subscription">
  
    
        <a href="http://blog.tonytsai.name/index.xml" target="_blank" type="application/rss+xml" title="RSS"><i class="fa fa-rss-square fa-lg"></i></a>
    
  

</ul>


</nav>


<div id="main">
  <div id="content">
    <div>
      <article class="hentry" role="article">

        
        

<header>
    <p class="meta">Nov 24, 2014
         - 19 minute read 
         - <a href="http://blog.tonytsai.name/blog/2014-11-24-rk4-method-for-solving-sir-model/#disqus_thread">Comments</a>

        
        
        
            - <a class="label" href="http://blog.tonytsai.name/categories/influenza/">Influenza </a>
        
    </p>
    <h1 class="entry-title">
         RK4 Method for Solving SIR Model 
    </h1>
</header>


        <div class="entry-content">
          
          
          
          
<div class="a2a_kit a2a_kit_size_32 a2a_default_style">
<a class="a2a_dd" href="https://www.addtoany.com/share"></a>
<a class="a2a_button_facebook"></a>
<a class="a2a_button_twitter"></a>
<a class="a2a_button_sina_weibo"></a>
<a class="a2a_button_wechat"></a>
<a class="a2a_button_douban"></a>
<a class="a2a_button_evernote"></a>
<a class="a2a_button_email"></a>
</div>
<script async src="https://static.addtoany.com/menu/page.js"></script>

<br>

          

<p>My object is to rewrite the 4th order Runge-Kutta (abbreviated for <strong>RK4</strong>) method for solving the absolute humidity-driven SIRS model developed by <a href="http://www.ploscompbiol.org/article/info%3Adoi%2F10.1371%2Fjournal.pcbi.1003583" target="_blank">Yang et al. (2014)</a> in <code>R</code> language. The details of the SIRS model are provided in the paper.</p>

<h2 id="1-rk4">1 RK4</h2>

<h3 id="1-1-preliminary">1.1 Preliminary</h3>

<p><strong>RK4</strong> is one of the classic methods for numerical integration of ODE models. A brief introduction of <strong>RK4</strong> refers to <a href="http://en.wikipedia.org/wiki/Runge%E2%80%93Kutta_methods" target="_blank">Wikipedia</a>.</p>

<p>Consider the following initial value problem of ODE
<div>
$$
\begin{equation}
\begin{aligned}
  &amp; \frac{dy}{dt} = f(t, y) \\<br />
  &amp; y(t_0) = y_0
\end{aligned}
\label{eq1}
\end{equation}
$$
</div>
where $y(t)$ is the unknown function (scalar or <strong>vector</strong>) which I would like to approximate.</p>

<p>The iterative formula of <strong>RK4</strong> method for solving ODE $(\ref{eq1})$ is as follows
$$
\begin{equation}
\begin{aligned}
  &amp; y_{n + 1} = y_n + \frac{\Delta t}{6}(k_1 + 2k_2 + 2k_3 + k_4) \\<br />
  &amp; k_1 = f(t_n, y_n) \\<br />
  &amp; k_2 = f(t_n + \frac{\Delta t}{2}, y_n + \frac{k_1\Delta t}{2}) \\<br />
  &amp; k_3 = f(t_n + \frac{\Delta t}{2}, y_n + \frac{k_2\Delta t}{2}) \\<br />
  &amp; k_4 = f(t_n + \Delta t, y_n + k_3\Delta t) \\<br />
  &amp; t_{n + 1} = t_n + \Delta t \\<br />
  &amp; n = 0, 1, 2, 3, \dots
\end{aligned}
\label{eq2}
\end{equation}
$$</p>

<p>For simplicity, here I use the simplest <a href="http://en.wikipedia.org/wiki/Compartmental_models_in_epidemiology" target="_blank">SIR model</a> rather than the SIRS model used in the paper to examine whether the <strong>RK4</strong> method has been implemented correctly. The SIR model is defined as follows
$$
\begin{equation} \label{eq3}
\begin{aligned}
  &amp; \frac{dS}{dt} = -\frac{\beta SI}{N} \\<br />
  &amp; \frac{dI}{dt} = \frac{\beta SI}{N} - \gamma I \\<br />
  &amp; \frac{dR}{dt} = \gamma I
\end{aligned}
\end{equation}
$$
where $S(t)$ is the number of susceptible people in the population at time $t$, $I(t)$ is the number of infectious people at time $t$, $R(t)$ is the number of recovered people at time $t$, $\beta$ is the transmission rate, $\gamma$ represents the recovery rate, and $N = S(t) + I(t) + R(t)$ is the fixed population.</p>

<p>According to the general iterative formula $(\ref{eq2})$, the iterative formulas for $S(t)$, $I(t)$ and $R(t)$ of SIR model can be written out.
$$
\begin{equation}
\begin{aligned}
  &amp; S_{n + 1} = S_n + \frac{\Delta t}{6}(k_1^S + 2k_2^S + 2k_3^S + k_4^S) \\<br />
  &amp; k_1^S = f(t_n, S_n, I_n) = -\frac{\beta S_nI_n}{N} \\<br />
  &amp; k_2^S = f(t_n + \frac{\Delta t}{2}, S_n + \frac{k_1^S\Delta t}{2}, I_n + \frac{k_1^I\Delta t}{2}) = -\frac{\beta}{N}(S_n + \frac{k_1^S\Delta t}{2})(I_n + \frac{k_1^I\Delta t}{2}) \\<br />
  &amp; k_3^S = f(t_n + \frac{\Delta t}{2}, S_n + \frac{k_2^S\Delta t}{2}, I_n + \frac{k_2^I\Delta t}{2}) = -\frac{\beta}{N}(S_n + \frac{k_2^S\Delta t}{2})(I_n + \frac{k_2^I\Delta t}{2}) \\<br />
  &amp; k_4^S = f(t_n + \Delta t, S_n + k_3^S\Delta t, I_n + k_3^I\Delta t) = -\frac{\beta}{N}(S_n + k_3^S\Delta t)(I_n + k_3^I\Delta t)
\end{aligned}
\end{equation}
$$</p>

<p>$$
\begin{equation}
\begin{aligned}
  &amp; I_{n + 1} = I_n + \frac{\Delta t}{6}(k_1^I + 2k_2^I + 2k_3^I + k_4^I) \\<br />
  &amp; k_1^I = f(t_n, S_n, I_n) = \frac{\beta S_nI_n}{N} - \gamma I_n \\<br />
  &amp; k_2^I = f(t_n + \frac{\Delta t}{2}, S_n + \frac{k_1^S\Delta t}{2}, I_n + \frac{k_1^I\Delta t}{2}) = \frac{\beta}{N}(S_n + \frac{k_1^S\Delta t}{2})(I_n + \frac{k_1^I\Delta t}{2}) - \gamma (I_n + \frac{k_1^I\Delta t}{2}) \\<br />
  &amp; k_3^I = f(t_n + \frac{\Delta t}{2}, S_n + \frac{k_2^S\Delta t}{2}, I_n + \frac{k_2^I\Delta t}{2}) = \frac{\beta}{N}(S_n + \frac{k_2^S\Delta t}{2})(I_n + \frac{k_2^I\Delta t}{2}) - \gamma (I_n + \frac{k_2^I\Delta t}{2}) \\<br />
  &amp; k_4^I = f(t_n + \Delta t, S_n + k_3^S\Delta t, I_n + k_3^I\Delta t) = \frac{\beta}{N}(S_n + k_3^S\Delta t)(I_n + k_3^I\Delta t) - \gamma (I_n + k_3^I\Delta t)
\end{aligned}
\end{equation}
$$</p>

<p>$$
\begin{equation}
\begin{aligned}
  &amp; R_{n + 1} = R_n + \frac{\Delta t}{6}(k_1^R + 2k_2^R + 2k_3^R + k_4^R) \\<br />
  &amp; k_1^R = f(t_n, I_n) = \gamma I_n \\<br />
  &amp; k_2^R = f(t_n + \frac{\Delta t}{2}, I_n + \frac{k_1^I\Delta t}{2}) = \gamma (I_n + \frac{k_1^I\Delta t}{2}) \\<br />
  &amp; k_3^R = f(t_n + \frac{\Delta t}{2}, I_n + \frac{k_2^I\Delta t}{2}) = \gamma (I_n + \frac{k_2^I\Delta t}{2}) \\<br />
  &amp; k_4^R = f(t_n + \Delta t, I_n + k_3^I\Delta t) = \gamma (I_n + k_3^I\Delta t)
\end{aligned}
\end{equation}
$$</p>

<p>Note that since the population $N = S(t) + I(t) + R(t)$ is constant, there will have $\frac{dS}{dt} + \frac{dI}{dt} + \frac{dR}{dt} = 0$. Therefore, only two of the three ODEs are independent and sufficient to solve the ODEs. Here, only iterative formulas for $S(t)$ and $I(t)$ are used and $R(t)$ is calculated by $R(t) = N - S(t) - I(t)$.</p>

<p>The specific simulation parameters for SIR model are from the study case of <a href="https://www.math.duke.edu//education/ccp/materials/diffcalc/sir/sir1.html" target="_blank">spread of Hong Kong flu in New York city</a>. The inital values for the population variables are
$$
\begin{aligned}
  &amp; S(0) = 7,900,000 \\<br />
  &amp; I(0) = 10 \\<br />
  &amp; R(0) = 0 \\<br />
  &amp; N = S(0) + I(0) + R(0) = 7,900,010
\end{aligned}
$$
and the values for the parameters are $\beta = \frac{1}{2}$, $\gamma = \frac{1}{3}$. All the following numerical methods solve the SIR model with a step size $\Delta t = 1$ day and time steps $t$ ranging from 0 to 200 days.</p>

<h3 id="1-2-rk4sir-function">1.2 <code>RK4SIR</code> function</h3>

<p>Firstly, I need three helper functions to describe the dynamic of <strong>S</strong>, <strong>I</strong> and <strong>R</strong> compartments of SIR model. For variants of SIR model, these functions can be easily modified accordingly.</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span></span>dSdt <span style="color: #719e07">&lt;-</span> <span style="color: #268BD2">function</span><span style="color: #93A1A1">(</span><span style="color: #719e07">t</span><span style="color: #93A1A1">,</span> S<span style="color: #93A1A1">,</span> <span style="color: #719e07">I</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">{</span>
  <span style="color: #268BD2">return</span><span style="color: #93A1A1">(</span><span style="color: #719e07">-</span> beta <span style="color: #719e07">*</span> S <span style="color: #719e07">*</span> I <span style="color: #719e07">/</span> N<span style="color: #93A1A1">)</span>
<span style="color: #93A1A1">}</span>

dIdt <span style="color: #719e07">&lt;-</span> <span style="color: #268BD2">function</span><span style="color: #93A1A1">(</span><span style="color: #719e07">t</span><span style="color: #93A1A1">,</span> S<span style="color: #93A1A1">,</span> <span style="color: #719e07">I</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">{</span>
  <span style="color: #268BD2">return</span><span style="color: #93A1A1">(</span>beta <span style="color: #719e07">*</span> S <span style="color: #719e07">*</span> I <span style="color: #719e07">/</span> N <span style="color: #719e07">-</span> gamma <span style="color: #719e07">*</span> <span style="color: #719e07">I</span><span style="color: #93A1A1">)</span>
<span style="color: #93A1A1">}</span>

dRdt <span style="color: #719e07">&lt;-</span> <span style="color: #268BD2">function</span><span style="color: #93A1A1">(</span><span style="color: #719e07">t</span><span style="color: #93A1A1">,</span> <span style="color: #719e07">I</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">{</span>
  <span style="color: #268BD2">return</span><span style="color: #93A1A1">(</span>gamma <span style="color: #719e07">*</span> <span style="color: #719e07">I</span><span style="color: #93A1A1">)</span>
<span style="color: #93A1A1">}</span>
</pre></div>

<p>Note that the <code>dRdt</code> function will not be called hereinafter. Here, it&rsquo;s still defined just for the integrity of SIR model and easily understanding.</p>

<p>Secondly, as per the algorithm of <strong>RK4</strong>, I create the following <code>RK4SIR</code> function to solve the SIR model.</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span></span>RK4SIR <span style="color: #719e07">&lt;-</span> <span style="color: #268BD2">function</span><span style="color: #93A1A1">(</span>n<span style="color: #93A1A1">,</span> <span style="color: #719e07">beta</span><span style="color: #93A1A1">,</span> <span style="color: #719e07">gamma</span><span style="color: #93A1A1">,</span> S0<span style="color: #93A1A1">,</span> I0<span style="color: #93A1A1">,</span> R0 <span style="color: #719e07">=</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> dt <span style="color: #719e07">=</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">{</span>
  N <span style="color: #719e07">&lt;&lt;-</span> S0 <span style="color: #719e07">+</span> I0 <span style="color: #719e07">+</span> R0  <span style="color: #586E75"># fixed population</span>
  
  S <span style="color: #719e07">&lt;-</span> <span style="color: #DC322F">c</span><span style="color: #93A1A1">(</span>S0<span style="color: #93A1A1">,</span> <span style="color: #719e07">rep</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> n<span style="color: #93A1A1">))</span>
  I <span style="color: #719e07">&lt;-</span> <span style="color: #DC322F">c</span><span style="color: #93A1A1">(</span>I0<span style="color: #93A1A1">,</span> <span style="color: #719e07">rep</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> n<span style="color: #93A1A1">))</span>
  R <span style="color: #719e07">&lt;-</span> <span style="color: #DC322F">c</span><span style="color: #93A1A1">(</span>R0<span style="color: #93A1A1">,</span> <span style="color: #719e07">rep</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> n<span style="color: #93A1A1">))</span>
  <span style="color: #268BD2">for</span><span style="color: #93A1A1">(</span>i <span style="color: #268BD2">in</span> <span style="color: #2AA198">1</span><span style="color: #719e07">:</span>n<span style="color: #93A1A1">)</span> <span style="color: #93A1A1">{</span>
    Si <span style="color: #719e07">&lt;-</span> S<span style="color: #93A1A1">[</span>i<span style="color: #93A1A1">]</span>
    Ii <span style="color: #719e07">&lt;-</span> <span style="color: #719e07">I</span><span style="color: #93A1A1">[</span>i<span style="color: #93A1A1">]</span>
<span style="color: #586E75">#     Ri &lt;- R[i]</span>
    
    S.k1 <span style="color: #719e07">&lt;-</span> dSdt<span style="color: #93A1A1">(</span>i<span style="color: #93A1A1">,</span> Si<span style="color: #93A1A1">,</span> Ii<span style="color: #93A1A1">)</span>
    I.k1 <span style="color: #719e07">&lt;-</span> dIdt<span style="color: #93A1A1">(</span>i<span style="color: #93A1A1">,</span> Si<span style="color: #93A1A1">,</span> Ii<span style="color: #93A1A1">)</span>
<span style="color: #586E75">#     R.k1 &lt;- dRdt(i, Ii)</span>
    
    S.k2 <span style="color: #719e07">&lt;-</span> dSdt<span style="color: #93A1A1">(</span>i <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span><span style="color: #93A1A1">,</span> Si <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> S.k1<span style="color: #93A1A1">,</span> Ii <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> I.k1<span style="color: #93A1A1">)</span>
    I.k2 <span style="color: #719e07">&lt;-</span> dIdt<span style="color: #93A1A1">(</span>i <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span><span style="color: #93A1A1">,</span> Si <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> S.k1<span style="color: #93A1A1">,</span> Ii <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> I.k1<span style="color: #93A1A1">)</span>
<span style="color: #586E75">#     R.k2 &lt;- dRdt(i + dt / 2, Ii + dt / 2 * I.k1)</span>
    
    S.k3 <span style="color: #719e07">&lt;-</span> dSdt<span style="color: #93A1A1">(</span>i <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span><span style="color: #93A1A1">,</span> Si <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> S.k2<span style="color: #93A1A1">,</span> Ii <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> I.k2<span style="color: #93A1A1">)</span>
    I.k3 <span style="color: #719e07">&lt;-</span> dIdt<span style="color: #93A1A1">(</span>i <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span><span style="color: #93A1A1">,</span> Si <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> S.k2<span style="color: #93A1A1">,</span> Ii <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> I.k2<span style="color: #93A1A1">)</span>
<span style="color: #586E75">#     R.k3 &lt;- dRdt(i + dt / 2, Ii + dt / 2 * I.k2)</span>
    
    S.k4 <span style="color: #719e07">&lt;-</span> dSdt<span style="color: #93A1A1">(</span>i <span style="color: #719e07">+</span> dt<span style="color: #93A1A1">,</span> Si <span style="color: #719e07">+</span> dt <span style="color: #719e07">*</span> S.k3<span style="color: #93A1A1">,</span> Ii <span style="color: #719e07">+</span> dt <span style="color: #719e07">*</span> I.k3<span style="color: #93A1A1">)</span>
    I.k4 <span style="color: #719e07">&lt;-</span> dIdt<span style="color: #93A1A1">(</span>i <span style="color: #719e07">+</span> dt<span style="color: #93A1A1">,</span> Si <span style="color: #719e07">+</span> dt <span style="color: #719e07">*</span> S.k3<span style="color: #93A1A1">,</span> Ii <span style="color: #719e07">+</span> dt <span style="color: #719e07">*</span> I.k3<span style="color: #93A1A1">)</span>
<span style="color: #586E75">#     R.k4 &lt;- dRdt(i + dt, Ii + dt * I.k3)</span>
    
    S<span style="color: #93A1A1">[</span>i <span style="color: #719e07">+</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">&lt;-</span> Si <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">6</span> <span style="color: #719e07">*</span> <span style="color: #93A1A1">(</span>S.k1 <span style="color: #719e07">+</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> S.k2 <span style="color: #719e07">+</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> S.k3 <span style="color: #719e07">+</span> S.k4<span style="color: #93A1A1">)</span>
    <span style="color: #719e07">I</span><span style="color: #93A1A1">[</span>i <span style="color: #719e07">+</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">&lt;-</span> Ii <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">6</span> <span style="color: #719e07">*</span> <span style="color: #93A1A1">(</span>I.k1 <span style="color: #719e07">+</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> I.k2 <span style="color: #719e07">+</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> I.k3 <span style="color: #719e07">+</span> I.k4<span style="color: #93A1A1">)</span>
<span style="color: #586E75">#     R[i + 1] &lt;- Ri + dt / 6 * (R.k1 + 2 * R.k2 + 2 * R.k3 + R.k4)</span>
  <span style="color: #93A1A1">}</span>
  R <span style="color: #719e07">&lt;-</span> N <span style="color: #719e07">-</span> S <span style="color: #719e07">-</span> <span style="color: #719e07">I</span>
  <span style="color: #268BD2">return</span><span style="color: #93A1A1">(</span><span style="color: #DC322F">data.frame</span><span style="color: #93A1A1">(</span>n <span style="color: #719e07">=</span> <span style="color: #2AA198">0</span> <span style="color: #719e07">:</span> n<span style="color: #93A1A1">,</span> S <span style="color: #719e07">=</span> S<span style="color: #93A1A1">,</span> I <span style="color: #719e07">=</span> <span style="color: #719e07">I</span><span style="color: #93A1A1">,</span> R <span style="color: #719e07">=</span> R<span style="color: #93A1A1">))</span>
<span style="color: #93A1A1">}</span>
</pre></div>

<p>Last, call <code>RK4SIR</code> to simulate the spread of Hong Kong flu in New York city.</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span></span>S0 <span style="color: #719e07">&lt;-</span> <span style="color: #2AA198">7900000</span>
I0 <span style="color: #719e07">&lt;-</span> <span style="color: #2AA198">10</span>
<span style="color: #586E75"># R0 &lt;- 0</span>
<span style="color: #586E75"># N &lt;- S0 + I0 + R0</span>
beta <span style="color: #719e07">&lt;-</span> <span style="color: #2AA198">1</span> <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span>
gamma <span style="color: #719e07">&lt;-</span> <span style="color: #2AA198">1</span> <span style="color: #719e07">/</span> <span style="color: #2AA198">3</span>
n <span style="color: #719e07">&lt;-</span> <span style="color: #2AA198">200</span>

r <span style="color: #719e07">&lt;-</span> RK4SIR<span style="color: #93A1A1">(</span>n<span style="color: #93A1A1">,</span> <span style="color: #719e07">beta</span><span style="color: #93A1A1">,</span> <span style="color: #719e07">gamma</span><span style="color: #93A1A1">,</span> S0<span style="color: #93A1A1">,</span> I0<span style="color: #93A1A1">)</span>
</pre></div>

<p>Use <code>ggplot2</code> package to plot the resulting $S(t)$, $I(t)$ and $R(t)$ curves.</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span></span><span style="color: #719e07">library</span><span style="color: #93A1A1">(</span>reshape2<span style="color: #93A1A1">)</span>
r.plot <span style="color: #719e07">&lt;-</span> melt<span style="color: #93A1A1">(</span>r<span style="color: #93A1A1">,</span> id <span style="color: #719e07">=</span> <span style="color: #2AA198">&quot;n&quot;</span><span style="color: #93A1A1">,</span> measure <span style="color: #719e07">=</span> <span style="color: #DC322F">c</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">&quot;S&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;I&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;R&quot;</span><span style="color: #93A1A1">))</span>
<span style="color: #719e07">library</span><span style="color: #93A1A1">(</span>ggplot2<span style="color: #93A1A1">)</span>
p <span style="color: #719e07">&lt;-</span> ggplot<span style="color: #93A1A1">(</span>r.plot<span style="color: #93A1A1">,</span> aes<span style="color: #93A1A1">(</span>x <span style="color: #719e07">=</span> n<span style="color: #93A1A1">,</span> y <span style="color: #719e07">=</span> value<span style="color: #93A1A1">,</span> group <span style="color: #719e07">=</span> variable<span style="color: #93A1A1">,</span> color <span style="color: #719e07">=</span> variable<span style="color: #93A1A1">))</span>
p <span style="color: #719e07">+</span> geom_line<span style="color: #93A1A1">()</span> <span style="color: #719e07">+</span> 
  ggtitle<span style="color: #93A1A1">(</span><span style="color: #2AA198">&quot;Spread of Hong Kong Flu in New York City&quot;</span><span style="color: #93A1A1">)</span>
</pre></div>

<p><img src="http://tonytsai.name/materials/RK4SIR_files/figure-html/unnamed-chunk-4-1.png" alt="" /></p>

<p>For the spread dynamic of the disease, I am interested in the time $t_{max}$ when the number of infected people gets maximum and the corresponding maximum number of infected people $I_{max}$. $t_{max}$ and $I_{max}$ are also key measures to evaluate the performance of the absolute humidity-driven SIRS model in <a href="http://www.ploscompbiol.org/article/info%3Adoi%2F10.1371%2Fjournal.pcbi.1003583" target="_blank">Yang et al. (2014)</a>. The following codes give $t_{max}$ and $I_{max}$.</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span></span><span style="color: #719e07">which.max</span><span style="color: #93A1A1">(</span>r<span style="color: #719e07">$I</span><span style="color: #93A1A1">)</span>
</pre></div>

<pre><code>## [1] 75
</code></pre>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span></span><span style="color: #719e07">max</span><span style="color: #93A1A1">(</span>r<span style="color: #719e07">$I</span><span style="color: #93A1A1">)</span>
</pre></div>

<pre><code>## [1] 497473.6
</code></pre>

<p>Comparing to the results of the study case <a href="https://www.math.duke.edu//education/ccp/materials/diffcalc/sir/sir2.html" target="_blank">The SIR Model for Spread of Disease</a>, the trends of $S(t)$, $I(t)$ and $R(t)$ curves are correct. Furthermore, $t_{max} = 75$ is the same to the approximate value of 75 identified from the figure.</p>

<h3 id="1-3-rk4sir-yang-function">1.3 <code>RK4SIR.Yang</code> function</h3>

<p>Based on the <code>propagateParSIR</code> function from the code shipping with <a href="http://www.ploscompbiol.org/article/info%3Adoi%2F10.1371%2Fjournal.pcbi.1003583" target="_blank">Yang et al. (2014)</a>, I just reproduce the algorithm for easily understanding and create the following function <code>RK4SIR.Yang</code> to solve the SIR model.</p>

<p>

<figure class="code">
  <figcaption>
  	<span></span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span></span>RK4SIR.Yang <span style="color: #719e07">&lt;-</span> <span style="color: #268BD2">function</span><span style="color: #93A1A1">(</span>n<span style="color: #93A1A1">,</span> <span style="color: #719e07">beta</span><span style="color: #93A1A1">,</span> <span style="color: #719e07">gamma</span><span style="color: #93A1A1">,</span> S0<span style="color: #93A1A1">,</span> I0<span style="color: #93A1A1">,</span> R0 <span style="color: #719e07">=</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> dt <span style="color: #719e07">=</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">{</span>
  N <span style="color: #719e07">&lt;&lt;-</span> S0 <span style="color: #719e07">+</span> I0 <span style="color: #719e07">+</span> R0  <span style="color: #586E75"># fixed population</span>
  
  S <span style="color: #719e07">&lt;-</span> <span style="color: #DC322F">c</span><span style="color: #93A1A1">(</span>S0<span style="color: #93A1A1">,</span> <span style="color: #719e07">rep</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> n<span style="color: #93A1A1">))</span>
  I <span style="color: #719e07">&lt;-</span> <span style="color: #DC322F">c</span><span style="color: #93A1A1">(</span>I0<span style="color: #93A1A1">,</span> <span style="color: #719e07">rep</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> n<span style="color: #93A1A1">))</span>
  R <span style="color: #719e07">&lt;-</span> <span style="color: #DC322F">c</span><span style="color: #93A1A1">(</span>R0<span style="color: #93A1A1">,</span> <span style="color: #719e07">rep</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> n<span style="color: #93A1A1">))</span>
  <span style="color: #268BD2">for</span><span style="color: #93A1A1">(</span>i <span style="color: #268BD2">in</span> <span style="color: #2AA198">1</span><span style="color: #719e07">:</span>n<span style="color: #93A1A1">)</span> <span style="color: #93A1A1">{</span>
    Si <span style="color: #719e07">&lt;-</span> S<span style="color: #93A1A1">[</span>i<span style="color: #93A1A1">]</span>
    Ii <span style="color: #719e07">&lt;-</span> <span style="color: #719e07">I</span><span style="color: #93A1A1">[</span>i<span style="color: #93A1A1">]</span>
    S.k1 <span style="color: #719e07">&lt;-</span> dSdt<span style="color: #93A1A1">(</span>i<span style="color: #93A1A1">,</span> Si<span style="color: #93A1A1">,</span> Ii<span style="color: #93A1A1">)</span>
    I.k1 <span style="color: #719e07">&lt;-</span> dIdt<span style="color: #93A1A1">(</span>i<span style="color: #93A1A1">,</span> Si<span style="color: #93A1A1">,</span> Ii<span style="color: #93A1A1">)</span>
    
    Ts1 <span style="color: #719e07">&lt;-</span> Si <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> S.k1
    Ti1 <span style="color: #719e07">&lt;-</span> Ii <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> I.k1
    S.k2 <span style="color: #719e07">&lt;-</span> dSdt<span style="color: #93A1A1">(</span>i <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span><span style="color: #93A1A1">,</span> Ts1<span style="color: #93A1A1">,</span> Ti1<span style="color: #93A1A1">)</span>
    I.k2 <span style="color: #719e07">&lt;-</span> dIdt<span style="color: #93A1A1">(</span>i <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span><span style="color: #93A1A1">,</span> Ts1<span style="color: #93A1A1">,</span> Ti1<span style="color: #93A1A1">)</span>
    
    Ts2 <span style="color: #719e07">&lt;-</span> Ts1 <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> S.k2
    Ti2 <span style="color: #719e07">&lt;-</span> Ti1 <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> I.k2
    S.k3 <span style="color: #719e07">&lt;-</span> dSdt<span style="color: #93A1A1">(</span>i <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span><span style="color: #93A1A1">,</span> Ts2<span style="color: #93A1A1">,</span> Ti2<span style="color: #93A1A1">)</span>
    I.k3 <span style="color: #719e07">&lt;-</span> dIdt<span style="color: #93A1A1">(</span>i <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span><span style="color: #93A1A1">,</span> Ts2<span style="color: #93A1A1">,</span> Ti2<span style="color: #93A1A1">)</span>
    
    Ts3 <span style="color: #719e07">&lt;-</span> Ts2 <span style="color: #719e07">+</span> dt <span style="color: #719e07">*</span> S.k3
    Ti3 <span style="color: #719e07">&lt;-</span> Ti2 <span style="color: #719e07">+</span> dt <span style="color: #719e07">*</span> I.k3
    S.k4 <span style="color: #719e07">&lt;-</span> dSdt<span style="color: #93A1A1">(</span>i <span style="color: #719e07">+</span> dt<span style="color: #93A1A1">,</span> Ts3<span style="color: #93A1A1">,</span> Ti3<span style="color: #93A1A1">)</span>
    I.k4 <span style="color: #719e07">&lt;-</span> dIdt<span style="color: #93A1A1">(</span>i <span style="color: #719e07">+</span> dt<span style="color: #93A1A1">,</span> Ts3<span style="color: #93A1A1">,</span> Ti3<span style="color: #93A1A1">)</span>
    
    S<span style="color: #93A1A1">[</span>i <span style="color: #719e07">+</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">&lt;-</span> Si <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">6</span> <span style="color: #719e07">*</span> <span style="color: #93A1A1">(</span>S.k1 <span style="color: #719e07">+</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> S.k2 <span style="color: #719e07">+</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> S.k3 <span style="color: #719e07">+</span> S.k4<span style="color: #93A1A1">)</span>
    <span style="color: #719e07">I</span><span style="color: #93A1A1">[</span>i <span style="color: #719e07">+</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">&lt;-</span> Ii <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">6</span> <span style="color: #719e07">*</span> <span style="color: #93A1A1">(</span>I.k1 <span style="color: #719e07">+</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> I.k2 <span style="color: #719e07">+</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> I.k3 <span style="color: #719e07">+</span> I.k4<span style="color: #93A1A1">)</span>
    R<span style="color: #93A1A1">[</span>i <span style="color: #719e07">+</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">&lt;-</span> N <span style="color: #719e07">-</span> S<span style="color: #93A1A1">[</span>i <span style="color: #719e07">+</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">-</span> <span style="color: #719e07">I</span><span style="color: #93A1A1">[</span>i <span style="color: #719e07">+</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span>
  <span style="color: #93A1A1">}</span>
  <span style="color: #268BD2">return</span><span style="color: #93A1A1">(</span><span style="color: #DC322F">data.frame</span><span style="color: #93A1A1">(</span>n <span style="color: #719e07">=</span> <span style="color: #2AA198">0</span> <span style="color: #719e07">:</span> n<span style="color: #93A1A1">,</span> S <span style="color: #719e07">=</span> S<span style="color: #93A1A1">,</span> I <span style="color: #719e07">=</span> <span style="color: #719e07">I</span><span style="color: #93A1A1">,</span> R <span style="color: #719e07">=</span> R<span style="color: #93A1A1">))</span>
<span style="color: #93A1A1">}</span>
</pre></div>
</td></tr></table>
  </div>
</figure>

Note that <code>RK4SIR.Yang</code> is a bit different from <code>RK4SIR</code> in calculating $k_1$, $k_2$, $k_3$ and $k_4$. The functionality of <code>RK4SIR.Yang</code> is also tested by the same case.</p>

<p>Call <code>RK4SIR.Yang</code> to simulate the spread of Hong Kong flu in New York city.</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span></span>r <span style="color: #719e07">&lt;-</span> RK4SIR.Yang<span style="color: #93A1A1">(</span>n<span style="color: #93A1A1">,</span> <span style="color: #719e07">beta</span><span style="color: #93A1A1">,</span> <span style="color: #719e07">gamma</span><span style="color: #93A1A1">,</span> S0<span style="color: #93A1A1">,</span> I0<span style="color: #93A1A1">)</span>
</pre></div>

<p>Plot $S(t)$, $I(t)$ and $R(t)$ curves.</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span></span>r.plot <span style="color: #719e07">&lt;-</span> melt<span style="color: #93A1A1">(</span>r<span style="color: #93A1A1">,</span> id <span style="color: #719e07">=</span> <span style="color: #2AA198">&quot;n&quot;</span><span style="color: #93A1A1">,</span> measure <span style="color: #719e07">=</span> <span style="color: #DC322F">c</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">&quot;S&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;I&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;R&quot;</span><span style="color: #93A1A1">))</span>
p <span style="color: #719e07">&lt;-</span> ggplot<span style="color: #93A1A1">(</span>r.plot<span style="color: #93A1A1">,</span> aes<span style="color: #93A1A1">(</span>x <span style="color: #719e07">=</span> n<span style="color: #93A1A1">,</span> y <span style="color: #719e07">=</span> value<span style="color: #93A1A1">,</span> group <span style="color: #719e07">=</span> variable<span style="color: #93A1A1">,</span> color <span style="color: #719e07">=</span> variable<span style="color: #93A1A1">))</span>
p <span style="color: #719e07">+</span> geom_line<span style="color: #93A1A1">()</span> <span style="color: #719e07">+</span> 
  ggtitle<span style="color: #93A1A1">(</span><span style="color: #2AA198">&quot;Spread of Hong Kong Flu in New York City&quot;</span><span style="color: #93A1A1">)</span>
</pre></div>

<p><img src="http://tonytsai.name/materials/RK4SIR_files/figure-html/unnamed-chunk-8-1.png" alt="" /></p>

<p>Extract $t_{max}$ and $I_{max}$.</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span></span><span style="color: #719e07">which.max</span><span style="color: #93A1A1">(</span>r<span style="color: #719e07">$I</span><span style="color: #93A1A1">)</span>
</pre></div>

<pre><code>## [1] 72
</code></pre>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span></span><span style="color: #719e07">max</span><span style="color: #93A1A1">(</span>r<span style="color: #719e07">$I</span><span style="color: #93A1A1">)</span>
</pre></div>

<pre><code>## [1] 482429.6
</code></pre>

<p>Comparing to the results of <code>RK4SIR</code>, the results of <code>RK4SIR.Yang</code> show that the infected indiviuals reaching peak is 3 days earlier and the number of infected individuals is more than 15,000 less. I doubt the <code>RK4SIR.Yang</code> function gives a wrong solution. To figure out which function (<code>RK4SIR</code> or <code>RK4SIR.Yang</code>) implements the <strong>RK4</strong> method correctly,  I also solve the SIR model by directly calling ODE solvers from the existing software package, including <code>deSolve</code> package and <code>MATLAB</code>.</p>

<h3 id="1-4-desolve-package">1.4 <code>deSolve</code> package</h3>

<p><a href="http://cran.r-project.org/web/packages/deSolve/index.html" target="_blank"><code>deSolve</code></a> package provides general solvers for inital value problems of ODE, PDE, DAE and DDE. <code>rk4</code> function from <code>deSolve</code> package is an implementation of the classical <strong>RK4</strong> integration algorithm. The steps of invoking <code>rk4</code> function to solve the SIR model are as follows.</p>

<p>Firstly, define the initial values and parameters used in the SIR model.</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span></span><span style="color: #586E75"># initial (state) values for SIR model</span>
y0 <span style="color: #719e07">&lt;-</span> <span style="color: #DC322F">c</span><span style="color: #93A1A1">(</span>S <span style="color: #719e07">=</span> S0<span style="color: #93A1A1">,</span> I <span style="color: #719e07">=</span> I0<span style="color: #93A1A1">,</span> R <span style="color: #719e07">=</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">)</span>
<span style="color: #586E75"># vector of time steps</span>
times <span style="color: #719e07">&lt;-</span> <span style="color: #2AA198">0</span> <span style="color: #719e07">:</span> n
<span style="color: #586E75"># vector of parameters used in SIR model</span>
params <span style="color: #719e07">&lt;-</span> <span style="color: #DC322F">c</span><span style="color: #93A1A1">(</span>beta <span style="color: #719e07">=</span> <span style="color: #719e07">beta</span><span style="color: #93A1A1">,</span> gamma <span style="color: #719e07">=</span> <span style="color: #719e07">gamma</span><span style="color: #93A1A1">)</span>
</pre></div>

<p>Secondly, define the SIR model.</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span></span>SIR <span style="color: #719e07">&lt;-</span> <span style="color: #268BD2">function</span><span style="color: #93A1A1">(</span><span style="color: #719e07">t</span><span style="color: #93A1A1">,</span> y<span style="color: #93A1A1">,</span> params<span style="color: #93A1A1">)</span> <span style="color: #93A1A1">{</span>
  <span style="color: #719e07">with</span><span style="color: #93A1A1">(</span><span style="color: #719e07">as.list</span><span style="color: #93A1A1">(</span><span style="color: #DC322F">c</span><span style="color: #93A1A1">(</span>params<span style="color: #93A1A1">,</span> y<span style="color: #93A1A1">)),</span> <span style="color: #93A1A1">{</span>
    dS <span style="color: #719e07">&lt;-</span> <span style="color: #719e07">-</span> beta <span style="color: #719e07">*</span> S <span style="color: #719e07">*</span> I <span style="color: #719e07">/</span> N
    dI <span style="color: #719e07">&lt;-</span> beta <span style="color: #719e07">*</span> S <span style="color: #719e07">*</span> I <span style="color: #719e07">/</span> N <span style="color: #719e07">-</span> gamma <span style="color: #719e07">*</span> <span style="color: #719e07">I</span>
    dR <span style="color: #719e07">&lt;-</span> gamma <span style="color: #719e07">*</span> <span style="color: #719e07">I</span>
    <span style="color: #DC322F">list</span><span style="color: #93A1A1">(</span><span style="color: #DC322F">c</span><span style="color: #93A1A1">(</span>dS<span style="color: #93A1A1">,</span> dI<span style="color: #93A1A1">,</span> dR<span style="color: #93A1A1">))</span>
  <span style="color: #93A1A1">})</span>
<span style="color: #93A1A1">}</span>
</pre></div>

<p>Last, call <code>rk4</code> function to solve the SIR model and plot the results.</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span></span><span style="color: #719e07">library</span><span style="color: #93A1A1">(</span>deSolve<span style="color: #93A1A1">)</span>
r <span style="color: #719e07">&lt;-</span>  rk4<span style="color: #93A1A1">(</span>y0<span style="color: #93A1A1">,</span> times<span style="color: #93A1A1">,</span> SIR<span style="color: #93A1A1">,</span> params<span style="color: #93A1A1">)</span>
plot<span style="color: #93A1A1">(</span>r<span style="color: #93A1A1">)</span>
</pre></div>

<p><img src="http://tonytsai.name/materials/RK4SIR_files/figure-html/unnamed-chunk-12-1.png" alt="" /></p>

<p>Similarly, extract $t_{max}$ and $I_{max}$.</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span></span><span style="color: #719e07">which.max</span><span style="color: #93A1A1">(</span>r<span style="color: #93A1A1">[,</span> <span style="color: #2AA198">&quot;I&quot;</span><span style="color: #93A1A1">])</span>
</pre></div>

<pre><code>## [1] 75
</code></pre>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span></span><span style="color: #719e07">max</span><span style="color: #93A1A1">(</span>r<span style="color: #93A1A1">[,</span> <span style="color: #2AA198">&quot;I&quot;</span><span style="color: #93A1A1">])</span>
</pre></div>

<pre><code>## [1] 497473.6
</code></pre>

<p>The results are the same to those of <code>RK4SIR</code> function. As <code>deSolve</code> is a mature package and has been used by numerous users, I believe the $t_{max} = 75$ and  $I_{max} = 4.97474\times 10^{5}$ given by <code>RK4SIR</code> function are correct.</p>

<h3 id="1-5-ode45-function">1.5 <code>ode45</code> function</h3>

<p>Furthermore, I solve the SIR model by calling <code>ode45</code> function from <code>MATLAB</code> to further confirm my judgement. The codes are organized in two <code>MATLAB</code> scripts <code>SIR.m</code> and <code>simSIR.m</code>. Since the whole process is very similar to the <code>R</code> code, I would not explain the codes in detail. Here, I just present the codes.</p>

<p><code>SIR.m</code> defines the ODEs of the SIR model.</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span></span><span style="color: #719e07">function</span><span style="color: #93A1A1"> </span>dy <span style="color: #93A1A1">= </span><span style="color: #268BD2">SIR</span><span style="color: #93A1A1">(</span>t, y, beta, gamma, N<span style="color: #93A1A1">)</span>
<span style="color: #586E75">% only two ODEs of SIR model are independent</span>
<span style="color: #586E75">% solving three ODE together, MATLAB gives wrong solution</span>
<span style="color: #93A1A1">S</span> <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">y(</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">);</span>
<span style="color: #93A1A1">I</span> <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">y(</span><span style="color: #2AA198">2</span><span style="color: #93A1A1">);</span>
<span style="color: #93A1A1">dS</span> <span style="color: #93A1A1">=</span> <span style="color: #719e07">-</span> <span style="color: #B58900">beta</span> <span style="color: #719e07">*</span> <span style="color: #93A1A1">S</span> <span style="color: #719e07">*</span> <span style="color: #93A1A1">I</span> <span style="color: #719e07">/</span> <span style="color: #93A1A1">N;</span>
<span style="color: #93A1A1">dI</span> <span style="color: #93A1A1">=</span> <span style="color: #B58900">beta</span> <span style="color: #719e07">*</span> <span style="color: #93A1A1">S</span> <span style="color: #719e07">*</span> <span style="color: #93A1A1">I</span> <span style="color: #719e07">/</span> <span style="color: #93A1A1">N</span> <span style="color: #719e07">-</span> <span style="color: #B58900">gamma</span> <span style="color: #719e07">*</span> <span style="color: #93A1A1">I;</span>
<span style="color: #93A1A1">dy</span> <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">[dS,</span> <span style="color: #93A1A1">dI]</span><span style="color: #719e07">&#39;</span><span style="color: #93A1A1">;</span>
<span style="color: #719e07">end</span>
</pre></div>

<p><code>simSIR.m</code> runs the specific simulation of the spread of Hong Kong flu in New York city and gives the results of interest.</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span></span><span style="color: #93A1A1">clear</span>

<span style="color: #93A1A1">t</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">:</span><span style="color: #2AA198">200</span><span style="color: #93A1A1">;</span>
<span style="color: #93A1A1">S0</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">7900000</span><span style="color: #93A1A1">;</span>
<span style="color: #93A1A1">I0</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">10</span><span style="color: #93A1A1">;</span>
<span style="color: #93A1A1">R0</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">;</span>
<span style="color: #93A1A1">N</span> <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">S0</span> <span style="color: #719e07">+</span> <span style="color: #93A1A1">I0</span> <span style="color: #719e07">+</span> <span style="color: #93A1A1">R0;</span>
<span style="color: #93A1A1">y0</span> <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">[S0,</span> <span style="color: #93A1A1">I0];</span>
<span style="color: #B58900">beta</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">1</span> <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span><span style="color: #93A1A1">;</span>
<span style="color: #B58900">gamma</span> <span style="color: #93A1A1">=</span> <span style="color: #2AA198">1</span> <span style="color: #719e07">/</span> <span style="color: #2AA198">3</span><span style="color: #93A1A1">;</span>
<span style="color: #93A1A1">options</span> <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">[];</span>

<span style="color: #93A1A1">[T,</span> <span style="color: #93A1A1">Y]</span> <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">ode45(@SIR,</span> <span style="color: #93A1A1">t,</span> <span style="color: #93A1A1">y0,</span> <span style="color: #93A1A1">options,</span> <span style="color: #B58900">beta</span><span style="color: #93A1A1">,</span> <span style="color: #B58900">gamma</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">N);</span>
<span style="color: #586E75">% plot S, I, R curves</span>
<span style="color: #93A1A1">S</span> <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">Y(:,</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">);</span>
<span style="color: #93A1A1">I</span> <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">Y(:,</span> <span style="color: #2AA198">2</span><span style="color: #93A1A1">);</span>
<span style="color: #93A1A1">R</span> <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">N</span> <span style="color: #719e07">-</span> <span style="color: #93A1A1">S</span> <span style="color: #719e07">-</span> <span style="color: #93A1A1">I;</span>
<span style="color: #93A1A1">plot(T,</span> <span style="color: #93A1A1">S,</span> <span style="color: #2AA198">&#39;-r&#39;</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">T,</span> <span style="color: #93A1A1">I,</span> <span style="color: #2AA198">&#39;-g&#39;</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">T,</span> <span style="color: #93A1A1">R,</span> <span style="color: #2AA198">&#39;-b&#39;</span><span style="color: #93A1A1">)</span>
<span style="color: #93A1A1">title(</span><span style="color: #2AA198">&#39;Spread of Hong Kong Flu in New York City&#39;</span><span style="color: #93A1A1">)</span>
<span style="color: #93A1A1">xlabel(</span><span style="color: #2AA198">&#39;Days&#39;</span><span style="color: #93A1A1">)</span>
<span style="color: #93A1A1">ylabel(</span><span style="color: #2AA198">&#39;Value&#39;</span><span style="color: #93A1A1">)</span>
<span style="color: #93A1A1">legend(</span><span style="color: #2AA198">&#39;S&#39;</span><span style="color: #93A1A1">,</span><span style="color: #2AA198">&#39;I&#39;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&#39;R&#39;</span><span style="color: #93A1A1">)</span>

<span style="color: #586E75">% peak of the infected</span>
<span style="color: #93A1A1">[maxVal,</span> <span style="color: #93A1A1">ind]</span> <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">max(Y(:,</span> <span style="color: #2AA198">2</span><span style="color: #93A1A1">))</span>
<span style="color: #586E75">% add veritical line to indicate the peak</span>
<span style="color: #93A1A1">ylim</span> <span style="color: #93A1A1">=</span> <span style="color: #93A1A1">get(gca,</span> <span style="color: #2AA198">&#39;ylim&#39;</span><span style="color: #93A1A1">);</span>  <span style="color: #586E75">%  get y range</span>
<span style="color: #93A1A1">hold</span> <span style="color: #93A1A1">on</span>
<span style="color: #93A1A1">plot([ind</span> <span style="color: #719e07">-</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> <span style="color: #93A1A1">ind</span> <span style="color: #719e07">-</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">],</span> <span style="color: #93A1A1">[ylim(</span><span style="color: #2AA198">1</span><span style="color: #93A1A1">),</span> <span style="color: #93A1A1">ylim(</span><span style="color: #2AA198">2</span><span style="color: #93A1A1">)],</span> <span style="color: #2AA198">&#39;LineStyle&#39;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&#39;--&#39;</span><span style="color: #93A1A1">)</span>
</pre></div>

<p>The results of running <code>simSIR.m</code> are</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span></span><span style="color: #719e07">&gt;&gt;</span> <span style="color: #93A1A1">simSIR</span>

<span style="color: #93A1A1">ind</span> <span style="color: #93A1A1">=</span>

    <span style="color: #2AA198">75</span>
    
<span style="color: #93A1A1">maxVal</span> <span style="color: #93A1A1">=</span>

   <span style="color: #2AA198">4.9755e+05</span>
</pre></div>

<p><img src="http://tonytsai.name/materials/RK4SIR_files/figure-html/SIR.png" alt="" /></p>

<p>Note that by default <code>MATLAB</code>&rsquo;s <code>ode45</code> solver is <a href="http://en.wikipedia.org/wiki/Dormand%E2%80%93Prince_method" target="_blank">DormandPrince method</a> (alias <code>dopri5</code>), which is also a member of the RungeKutta family of ODE solvers. As <code>ode45</code> is adaptive stepsize integration algorithm, it can give more accurate numerical solution than <strong>RK4</strong> method.</p>

<p><code>rk45dp7</code> (alias <code>ode45</code>) method from <code>deSolve</code> package provides <code>ode45</code> solver for ODEs in <code>R</code>. Solve the SIR model by using <code>ode45</code> method in <code>deSolve</code> and extract $t_{max}$ and $I_{max}$.</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span></span>r <span style="color: #719e07">&lt;-</span>  ode<span style="color: #93A1A1">(</span>y0<span style="color: #93A1A1">,</span> times<span style="color: #93A1A1">,</span> SIR<span style="color: #93A1A1">,</span> params<span style="color: #93A1A1">,</span> method <span style="color: #719e07">=</span> rkMethod<span style="color: #93A1A1">(</span><span style="color: #2AA198">&quot;ode45&quot;</span><span style="color: #93A1A1">))</span>
<span style="color: #586E75"># peak of the infected</span>
<span style="color: #719e07">which.max</span><span style="color: #93A1A1">(</span>r<span style="color: #93A1A1">[,</span> <span style="color: #2AA198">&quot;I&quot;</span><span style="color: #93A1A1">])</span>
</pre></div>

<pre><code>## [1] 75
</code></pre>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span></span><span style="color: #719e07">max</span><span style="color: #93A1A1">(</span>r<span style="color: #93A1A1">[,</span> <span style="color: #2AA198">&quot;I&quot;</span><span style="color: #93A1A1">])</span>
</pre></div>

<pre><code>## [1] 497474.2
</code></pre>

<p>$I_{max}$ given by <code>rk4</code> and <code>ode45</code> from <code>deSolve</code> package are almost the same, but both are approximate 80 less than that of <code>ode45</code> in <code>MATLAB</code>. The results of <code>ode45</code> provided by <code>R</code> and <code>MATLAB</code> are both right as the discrepancy results from the inherent difference in numerical precision between <code>R</code> and <code>MATLAB</code>. For more details refer to <a href="http://blog.tonytsai.name/2014/11/Precision-Difference-of-ode45-between-R-and-MATLAB/" target="_blank">Appendix A</a>.</p>

<p>The results given by both <code>deSolve</code> package and <code>MATLAB</code> show that $I_{max} = 75$ is the right answer. I am pretty sure that the results from <code>RK4SIR</code> function are correct; however, the <code>RK4SIR.Yang</code> function  ${\color{red}{doesn&rsquo;t\ correctly}}$ implement <strong>RK4</strong> method for solving SIR model. Since the <code>RK4SIR.Yang</code> function gives a bit ealier $I_{max}$, I wonder whether this wrong <strong>RK4</strong> method has any influence on the conclusions of <a href="http://www.ploscompbiol.org/article/info%3Adoi%2F10.1371%2Fjournal.pcbi.1003583" target="_blank">Yang et al. (2014)</a></p>

<h2 id="2-incidence">2 Incidence</h2>

<h3 id="2-1-preliminary">2.1 Preliminary</h3>

<p>Instead of $S(t)$, $I(t)$ and $R(t)$ of SIR model, health workers in practice often collect daily number of newly infected people. This is the loosely expressed <a href="http://en.wikipedia.org/wiki/Incidence_%28epidemiology%29" target="_blank">incidence</a>. Besides incidence, cummulative incidence is also of interest. Let $C(t)$ denote incidence at time $t$, $P(t)$ denote cummulative incidence at time $t$. $C(t)$ and $P(t)$ can be calculated as follows
$$
\begin{aligned}
  &amp; C(t) = \frac{dP}{dt} = \frac{\beta SI}{N} \\<br />
  &amp; C(t_0) = S_0 \\<br />
  &amp; P(t) = \int_0^t{C(t)}dt = \int_0^t{\frac{\beta SI}{N}}dt
\end{aligned}
$$</p>

<p>In some references, <a href="http://en.wikipedia.org/wiki/Incidence_%28epidemiology%29" target="_blank">cummulative incidence</a> (also known as <strong>incidence proportion</strong>) refers to the number of new cases $P(T)$ within a specified time period $T$ divided by the size of the population initially at risk $N$, expressed as $P(T)$ cases per $N$ persons, or $\frac{P(T)}{N}\times 100\%$. The rigorous definition of incidence is <a href="http://en.wikipedia.org/wiki/Incidence_%28epidemiology%29#Incidence_rate" target="_blank">incidence rate</a>, which is expressed as $P(T)$ cases per $N$ persons per $T$ time, or $\frac{P(T)}{N\times T}\times 100\%$.</p>

<h3 id="2-2-rk4sir-function">2.2 <code>RK4SIR</code> function</h3>

<p>A logical parameter <code>incidence</code> is added to <code>RK4SIR</code> function to control whether or not incidence and cummulative incidence are returned.</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span></span>RK4SIR <span style="color: #719e07">&lt;-</span> <span style="color: #268BD2">function</span><span style="color: #93A1A1">(</span>n<span style="color: #93A1A1">,</span> <span style="color: #719e07">beta</span><span style="color: #93A1A1">,</span> <span style="color: #719e07">gamma</span><span style="color: #93A1A1">,</span> S0<span style="color: #93A1A1">,</span> I0<span style="color: #93A1A1">,</span> R0 <span style="color: #719e07">=</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> dt <span style="color: #719e07">=</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> incidence <span style="color: #719e07">=</span> <span style="color: #CB4B16">FALSE</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">{</span>
  N <span style="color: #719e07">&lt;&lt;-</span> S0 <span style="color: #719e07">+</span> I0 <span style="color: #719e07">+</span> R0
  
  S <span style="color: #719e07">&lt;-</span> <span style="color: #DC322F">c</span><span style="color: #93A1A1">(</span>S0<span style="color: #93A1A1">,</span> <span style="color: #719e07">rep</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> n<span style="color: #93A1A1">))</span>
  I <span style="color: #719e07">&lt;-</span> <span style="color: #DC322F">c</span><span style="color: #93A1A1">(</span>I0<span style="color: #93A1A1">,</span> <span style="color: #719e07">rep</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> n<span style="color: #93A1A1">))</span>
  R <span style="color: #719e07">&lt;-</span> <span style="color: #DC322F">c</span><span style="color: #93A1A1">(</span>R0<span style="color: #93A1A1">,</span> <span style="color: #719e07">rep</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> n<span style="color: #93A1A1">))</span>
  <span style="color: #268BD2">for</span><span style="color: #93A1A1">(</span>i <span style="color: #268BD2">in</span> <span style="color: #2AA198">1</span><span style="color: #719e07">:</span>n<span style="color: #93A1A1">)</span> <span style="color: #93A1A1">{</span>
    Si <span style="color: #719e07">&lt;-</span> S<span style="color: #93A1A1">[</span>i<span style="color: #93A1A1">]</span>
    Ii <span style="color: #719e07">&lt;-</span> <span style="color: #719e07">I</span><span style="color: #93A1A1">[</span>i<span style="color: #93A1A1">]</span>
    
    S.k1 <span style="color: #719e07">&lt;-</span> dSdt<span style="color: #93A1A1">(</span>i<span style="color: #93A1A1">,</span> Si<span style="color: #93A1A1">,</span> Ii<span style="color: #93A1A1">)</span>
    I.k1 <span style="color: #719e07">&lt;-</span> dIdt<span style="color: #93A1A1">(</span>i<span style="color: #93A1A1">,</span> Si<span style="color: #93A1A1">,</span> Ii<span style="color: #93A1A1">)</span>
    
    S.k2 <span style="color: #719e07">&lt;-</span> dSdt<span style="color: #93A1A1">(</span>i <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span><span style="color: #93A1A1">,</span> Si <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> S.k1<span style="color: #93A1A1">,</span> Ii <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> I.k1<span style="color: #93A1A1">)</span>
    I.k2 <span style="color: #719e07">&lt;-</span> dIdt<span style="color: #93A1A1">(</span>i <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span><span style="color: #93A1A1">,</span> Si <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> S.k1<span style="color: #93A1A1">,</span> Ii <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> I.k1<span style="color: #93A1A1">)</span>
    
    S.k3 <span style="color: #719e07">&lt;-</span> dSdt<span style="color: #93A1A1">(</span>i <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span><span style="color: #93A1A1">,</span> Si <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> S.k2<span style="color: #93A1A1">,</span> Ii <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> I.k2<span style="color: #93A1A1">)</span>
    I.k3 <span style="color: #719e07">&lt;-</span> dIdt<span style="color: #93A1A1">(</span>i <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span><span style="color: #93A1A1">,</span> Si <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> S.k2<span style="color: #93A1A1">,</span> Ii <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> I.k2<span style="color: #93A1A1">)</span>
    
    S.k4 <span style="color: #719e07">&lt;-</span> dSdt<span style="color: #93A1A1">(</span>i <span style="color: #719e07">+</span> dt<span style="color: #93A1A1">,</span> Si <span style="color: #719e07">+</span> dt <span style="color: #719e07">*</span> S.k3<span style="color: #93A1A1">,</span> Ii <span style="color: #719e07">+</span> dt <span style="color: #719e07">*</span> I.k3<span style="color: #93A1A1">)</span>
    I.k4 <span style="color: #719e07">&lt;-</span> dIdt<span style="color: #93A1A1">(</span>i <span style="color: #719e07">+</span> dt<span style="color: #93A1A1">,</span> Si <span style="color: #719e07">+</span> dt <span style="color: #719e07">*</span> S.k3<span style="color: #93A1A1">,</span> Ii <span style="color: #719e07">+</span> dt <span style="color: #719e07">*</span> I.k3<span style="color: #93A1A1">)</span>
    
    S<span style="color: #93A1A1">[</span>i <span style="color: #719e07">+</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">&lt;-</span> Si <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">6</span> <span style="color: #719e07">*</span> <span style="color: #93A1A1">(</span>S.k1 <span style="color: #719e07">+</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> S.k2 <span style="color: #719e07">+</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> S.k3 <span style="color: #719e07">+</span> S.k4<span style="color: #93A1A1">)</span>
    <span style="color: #719e07">I</span><span style="color: #93A1A1">[</span>i <span style="color: #719e07">+</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">&lt;-</span> Ii <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">6</span> <span style="color: #719e07">*</span> <span style="color: #93A1A1">(</span>I.k1 <span style="color: #719e07">+</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> I.k2 <span style="color: #719e07">+</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> I.k3 <span style="color: #719e07">+</span> I.k4<span style="color: #93A1A1">)</span>
  <span style="color: #93A1A1">}</span>
  R <span style="color: #719e07">&lt;-</span> N <span style="color: #719e07">-</span> S <span style="color: #719e07">-</span> <span style="color: #719e07">I</span>
  
  <span style="color: #268BD2">if</span> <span style="color: #93A1A1">(</span><span style="color: #719e07">!</span>incidence<span style="color: #93A1A1">)</span> <span style="color: #93A1A1">{</span>
    <span style="color: #268BD2">return</span><span style="color: #93A1A1">(</span><span style="color: #DC322F">data.frame</span><span style="color: #93A1A1">(</span>n <span style="color: #719e07">=</span> <span style="color: #2AA198">0</span> <span style="color: #719e07">:</span> n<span style="color: #93A1A1">,</span> S <span style="color: #719e07">=</span> S<span style="color: #93A1A1">,</span> I <span style="color: #719e07">=</span> <span style="color: #719e07">I</span><span style="color: #93A1A1">,</span> R <span style="color: #719e07">=</span> R<span style="color: #93A1A1">))</span>
  <span style="color: #93A1A1">}</span> <span style="color: #268BD2">else</span> <span style="color: #93A1A1">{</span>
    <span style="color: #586E75"># newly infected per day (incidence)</span>
    inc <span style="color: #719e07">=</span> <span style="color: #DC322F">c</span><span style="color: #93A1A1">(</span>I0<span style="color: #93A1A1">,</span> <span style="color: #719e07">-</span> <span style="color: #719e07">diff</span><span style="color: #93A1A1">(</span>S<span style="color: #93A1A1">))</span>
    <span style="color: #586E75"># cumulative incidence</span>
    cum.inc <span style="color: #719e07">=</span> <span style="color: #719e07">cumsum</span><span style="color: #93A1A1">(</span>inc<span style="color: #93A1A1">)</span>
    <span style="color: #268BD2">return</span><span style="color: #93A1A1">(</span><span style="color: #DC322F">data.frame</span><span style="color: #93A1A1">(</span>n <span style="color: #719e07">=</span> <span style="color: #2AA198">0</span> <span style="color: #719e07">:</span> n<span style="color: #93A1A1">,</span> S <span style="color: #719e07">=</span> S<span style="color: #93A1A1">,</span> I <span style="color: #719e07">=</span> <span style="color: #719e07">I</span><span style="color: #93A1A1">,</span> R <span style="color: #719e07">=</span> R<span style="color: #93A1A1">,</span> inc <span style="color: #719e07">=</span> inc<span style="color: #93A1A1">,</span> cum.inc <span style="color: #719e07">=</span> cum.inc<span style="color: #93A1A1">))</span>
  <span style="color: #93A1A1">}</span>
<span style="color: #93A1A1">}</span>
</pre></div>

<p>Use the updated <code>RK4SIR</code> function to track the time-varying incidence and cummulative incidence of the same study case.</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span></span>r <span style="color: #719e07">&lt;-</span> RK4SIR<span style="color: #93A1A1">(</span>n<span style="color: #93A1A1">,</span> <span style="color: #719e07">beta</span><span style="color: #93A1A1">,</span> <span style="color: #719e07">gamma</span><span style="color: #93A1A1">,</span> S0<span style="color: #93A1A1">,</span> I0<span style="color: #93A1A1">,</span> incidence <span style="color: #719e07">=</span> <span style="color: #CB4B16">TRUE</span><span style="color: #93A1A1">)</span>
<span style="color: #586E75"># # plot S, I, R, incidence, cummulative incidence curves</span>
r.plot <span style="color: #719e07">&lt;-</span> melt<span style="color: #93A1A1">(</span>r<span style="color: #93A1A1">,</span> id <span style="color: #719e07">=</span> <span style="color: #2AA198">&quot;n&quot;</span><span style="color: #93A1A1">,</span> measure <span style="color: #719e07">=</span> <span style="color: #DC322F">c</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">&quot;S&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;I&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;R&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;inc&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;cum.inc&quot;</span><span style="color: #93A1A1">))</span>
p <span style="color: #719e07">&lt;-</span> ggplot<span style="color: #93A1A1">(</span>r.plot<span style="color: #93A1A1">,</span> aes<span style="color: #93A1A1">(</span>x <span style="color: #719e07">=</span> n<span style="color: #93A1A1">,</span> y <span style="color: #719e07">=</span> value<span style="color: #93A1A1">,</span> group <span style="color: #719e07">=</span> variable<span style="color: #93A1A1">,</span> color <span style="color: #719e07">=</span> variable<span style="color: #93A1A1">))</span>
p <span style="color: #719e07">+</span> geom_line<span style="color: #93A1A1">()</span> <span style="color: #719e07">+</span> 
  scale_colour_discrete<span style="color: #93A1A1">(</span>name <span style="color: #719e07">=</span> <span style="color: #2AA198">&quot;Legend&quot;</span><span style="color: #93A1A1">,</span> 
                      breaks <span style="color: #719e07">=</span> <span style="color: #DC322F">c</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">&quot;S&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;I&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;R&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;inc&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;cum.inc&quot;</span><span style="color: #93A1A1">),</span> 
                      labels <span style="color: #719e07">=</span> <span style="color: #DC322F">c</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">&quot;Susceptible&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;Infected &quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;Recovered&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;Incidence&quot;</span><span style="color: #93A1A1">,</span> 
                               <span style="color: #2AA198">&quot;Cummulative incidence&quot;</span><span style="color: #93A1A1">))</span> <span style="color: #719e07">+</span> 
  ggtitle<span style="color: #93A1A1">(</span><span style="color: #2AA198">&quot;Spread of Hong Kong Flu in New York City&quot;</span><span style="color: #93A1A1">)</span>
</pre></div>

<p><img src="http://tonytsai.name/materials/RK4SIR_files/figure-html/unnamed-chunk-16-1.png" alt="" /></p>

<p>As shown in the above figure, the time when incidence reaches peak is a bit earlier than that of the infected people. The following codes give the exact results.</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span></span><span style="color: #719e07">which.max</span><span style="color: #93A1A1">(</span>r<span style="color: #719e07">$</span>inc<span style="color: #93A1A1">)</span>
</pre></div>

<pre><code>## [1] 73
</code></pre>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span></span><span style="color: #719e07">max</span><span style="color: #93A1A1">(</span>r<span style="color: #719e07">$</span>inc<span style="color: #93A1A1">)</span>
</pre></div>

<pre><code>## [1] 173488.5
</code></pre>

<h3 id="2-3-rk4sir-yang-function">2.3 <code>RK4SIR.Yang</code> function</h3>

<p>I also update <code>RK4SIR.Yang</code> function to return cummulative incidence based on the algorithm from <code>propagateParSIR</code> function. The initial cummulative incidence $C_0$ is 0, which is $S_0$ in <code>RK4SIR</code> function; however, I think it&rsquo;s more consistent to set $C_0 = S_0$. Notably, the <code>RK4</code> method for <code>RK4SIR.Yang</code> hasn&rsquo;t been corrected and the function doesn&rsquo;t return incidence.</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span></span>RK4SIR.Yang <span style="color: #719e07">&lt;-</span> <span style="color: #268BD2">function</span><span style="color: #93A1A1">(</span>n<span style="color: #93A1A1">,</span> <span style="color: #719e07">beta</span><span style="color: #93A1A1">,</span> <span style="color: #719e07">gamma</span><span style="color: #93A1A1">,</span> S0<span style="color: #93A1A1">,</span> I0<span style="color: #93A1A1">,</span> R0 <span style="color: #719e07">=</span> <span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> dt <span style="color: #719e07">=</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">,</span> incidence <span style="color: #719e07">=</span> <span style="color: #CB4B16">FALSE</span><span style="color: #93A1A1">)</span> <span style="color: #93A1A1">{</span>
  N <span style="color: #719e07">&lt;&lt;-</span> S0 <span style="color: #719e07">+</span> I0 <span style="color: #719e07">+</span> R0
  
  S <span style="color: #719e07">&lt;-</span> <span style="color: #DC322F">c</span><span style="color: #93A1A1">(</span>S0<span style="color: #93A1A1">,</span> <span style="color: #719e07">rep</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> n<span style="color: #93A1A1">))</span>
  I <span style="color: #719e07">&lt;-</span> <span style="color: #DC322F">c</span><span style="color: #93A1A1">(</span>I0<span style="color: #93A1A1">,</span> <span style="color: #719e07">rep</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> n<span style="color: #93A1A1">))</span>
  R <span style="color: #719e07">&lt;-</span> <span style="color: #DC322F">c</span><span style="color: #93A1A1">(</span>R0<span style="color: #93A1A1">,</span> <span style="color: #719e07">rep</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> n<span style="color: #93A1A1">))</span>
  cum.inc <span style="color: #719e07">&lt;-</span> <span style="color: #719e07">rep</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">0</span><span style="color: #93A1A1">,</span> n <span style="color: #719e07">+</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">)</span>  <span style="color: #586E75"># cumulative incidence</span>
  <span style="color: #268BD2">for</span><span style="color: #93A1A1">(</span>i <span style="color: #268BD2">in</span> <span style="color: #2AA198">1</span><span style="color: #719e07">:</span>n<span style="color: #93A1A1">)</span> <span style="color: #93A1A1">{</span>
    Si <span style="color: #719e07">&lt;-</span> S<span style="color: #93A1A1">[</span>i<span style="color: #93A1A1">]</span>
    Ii <span style="color: #719e07">&lt;-</span> <span style="color: #719e07">I</span><span style="color: #93A1A1">[</span>i<span style="color: #93A1A1">]</span>
    S.k1 <span style="color: #719e07">&lt;-</span> dSdt<span style="color: #93A1A1">(</span>i<span style="color: #93A1A1">,</span> Si<span style="color: #93A1A1">,</span> Ii<span style="color: #93A1A1">)</span>
    I.k1 <span style="color: #719e07">&lt;-</span> dIdt<span style="color: #93A1A1">(</span>i<span style="color: #93A1A1">,</span> Si<span style="color: #93A1A1">,</span> Ii<span style="color: #93A1A1">)</span>
    CI.k1 <span style="color: #719e07">&lt;-</span> <span style="color: #719e07">-</span> S.k1
    
    Ts1 <span style="color: #719e07">&lt;-</span> Si <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> S.k1
    Ti1 <span style="color: #719e07">&lt;-</span> Ii <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> I.k1
    S.k2 <span style="color: #719e07">&lt;-</span> dSdt<span style="color: #93A1A1">(</span>i <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span><span style="color: #93A1A1">,</span> Ts1<span style="color: #93A1A1">,</span> Ti1<span style="color: #93A1A1">)</span>
    I.k2 <span style="color: #719e07">&lt;-</span> dIdt<span style="color: #93A1A1">(</span>i <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span><span style="color: #93A1A1">,</span> Ts1<span style="color: #93A1A1">,</span> Ti1<span style="color: #93A1A1">)</span>
    CI.k2 <span style="color: #719e07">&lt;-</span> <span style="color: #719e07">-</span> S.k2
    
    Ts2 <span style="color: #719e07">&lt;-</span> Ts1 <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> S.k2
    Ti2 <span style="color: #719e07">&lt;-</span> Ti1 <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> I.k2
    S.k3 <span style="color: #719e07">&lt;-</span> dSdt<span style="color: #93A1A1">(</span>i <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span><span style="color: #93A1A1">,</span> Ts2<span style="color: #93A1A1">,</span> Ti2<span style="color: #93A1A1">)</span>
    I.k3 <span style="color: #719e07">&lt;-</span> dIdt<span style="color: #93A1A1">(</span>i <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">2</span><span style="color: #93A1A1">,</span> Ts2<span style="color: #93A1A1">,</span> Ti2<span style="color: #93A1A1">)</span>
    CI.k3 <span style="color: #719e07">&lt;-</span> <span style="color: #719e07">-</span> S.k3
    
    Ts3 <span style="color: #719e07">&lt;-</span> Ts2 <span style="color: #719e07">+</span> dt <span style="color: #719e07">*</span> S.k3
    Ti3 <span style="color: #719e07">&lt;-</span> Ti2 <span style="color: #719e07">+</span> dt <span style="color: #719e07">*</span> I.k3
    S.k4 <span style="color: #719e07">&lt;-</span> dSdt<span style="color: #93A1A1">(</span>i <span style="color: #719e07">+</span> dt<span style="color: #93A1A1">,</span> Ts3<span style="color: #93A1A1">,</span> Ti3<span style="color: #93A1A1">)</span>
    I.k4 <span style="color: #719e07">&lt;-</span> dIdt<span style="color: #93A1A1">(</span>i <span style="color: #719e07">+</span> dt<span style="color: #93A1A1">,</span> Ts3<span style="color: #93A1A1">,</span> Ti3<span style="color: #93A1A1">)</span>
    CI.k4 <span style="color: #719e07">&lt;-</span> <span style="color: #719e07">-</span> S.k4
    
    S<span style="color: #93A1A1">[</span>i <span style="color: #719e07">+</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">&lt;-</span> Si <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">6</span> <span style="color: #719e07">*</span> <span style="color: #93A1A1">(</span>S.k1 <span style="color: #719e07">+</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> S.k2 <span style="color: #719e07">+</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> S.k3 <span style="color: #719e07">+</span> S.k4<span style="color: #93A1A1">)</span>
    <span style="color: #719e07">I</span><span style="color: #93A1A1">[</span>i <span style="color: #719e07">+</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">&lt;-</span> Ii <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">6</span> <span style="color: #719e07">*</span> <span style="color: #93A1A1">(</span>I.k1 <span style="color: #719e07">+</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> I.k2 <span style="color: #719e07">+</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> I.k3 <span style="color: #719e07">+</span> I.k4<span style="color: #93A1A1">)</span>
    R<span style="color: #93A1A1">[</span>i <span style="color: #719e07">+</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">&lt;-</span> N <span style="color: #719e07">-</span> S<span style="color: #93A1A1">[</span>i <span style="color: #719e07">+</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">-</span> <span style="color: #719e07">I</span><span style="color: #93A1A1">[</span>i <span style="color: #719e07">+</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span>
    cum.inc<span style="color: #93A1A1">[</span>i <span style="color: #719e07">+</span> <span style="color: #2AA198">1</span><span style="color: #93A1A1">]</span> <span style="color: #719e07">&lt;-</span> cum.inc<span style="color: #93A1A1">[</span>i<span style="color: #93A1A1">]</span> <span style="color: #719e07">+</span> dt <span style="color: #719e07">/</span> <span style="color: #2AA198">6</span> <span style="color: #719e07">*</span> <span style="color: #93A1A1">(</span>CI.k1 <span style="color: #719e07">+</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> CI.k2 <span style="color: #719e07">+</span> <span style="color: #2AA198">2</span> <span style="color: #719e07">*</span> CI.k3 <span style="color: #719e07">+</span> CI.k4<span style="color: #93A1A1">)</span>
  <span style="color: #93A1A1">}</span>
  <span style="color: #268BD2">if</span> <span style="color: #93A1A1">(</span><span style="color: #719e07">!</span>incidence<span style="color: #93A1A1">)</span> <span style="color: #93A1A1">{</span>
    <span style="color: #268BD2">return</span><span style="color: #93A1A1">(</span><span style="color: #DC322F">data.frame</span><span style="color: #93A1A1">(</span>n <span style="color: #719e07">=</span> <span style="color: #2AA198">0</span> <span style="color: #719e07">:</span> n<span style="color: #93A1A1">,</span> S <span style="color: #719e07">=</span> S<span style="color: #93A1A1">,</span> I <span style="color: #719e07">=</span> <span style="color: #719e07">I</span><span style="color: #93A1A1">,</span> R <span style="color: #719e07">=</span> R<span style="color: #93A1A1">))</span>
  <span style="color: #93A1A1">}</span> <span style="color: #268BD2">else</span> <span style="color: #93A1A1">{</span>
    <span style="color: #268BD2">return</span><span style="color: #93A1A1">(</span><span style="color: #DC322F">data.frame</span><span style="color: #93A1A1">(</span>n <span style="color: #719e07">=</span> <span style="color: #2AA198">0</span> <span style="color: #719e07">:</span> n<span style="color: #93A1A1">,</span> S <span style="color: #719e07">=</span> S<span style="color: #93A1A1">,</span> I <span style="color: #719e07">=</span> <span style="color: #719e07">I</span><span style="color: #93A1A1">,</span> R <span style="color: #719e07">=</span> R<span style="color: #93A1A1">,</span> cum.inc <span style="color: #719e07">=</span> cum.inc<span style="color: #93A1A1">))</span>
  <span style="color: #93A1A1">}</span>
<span style="color: #93A1A1">}</span>
</pre></div>

<h3 id="2-4-benchmark">2.4 Benchmark</h3>

<p><code>microbenchmark</code> package is a good option for benchmarking functions. I use <code>microbenchmark</code> function to compare <code>rk4</code>, <code>RK4SIR</code> and <code>RK4SIR.Yang</code> 1000 times.</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span></span><span style="color: #719e07">library</span><span style="color: #93A1A1">(</span>microbenchmark<span style="color: #93A1A1">)</span>
compare <span style="color: #719e07">&lt;-</span> microbenchmark<span style="color: #93A1A1">(</span>rk4<span style="color: #93A1A1">(</span>y0<span style="color: #93A1A1">,</span> times<span style="color: #93A1A1">,</span> SIR<span style="color: #93A1A1">,</span> params<span style="color: #93A1A1">),</span> 
                          RK4SIR<span style="color: #93A1A1">(</span>n<span style="color: #93A1A1">,</span> <span style="color: #719e07">beta</span><span style="color: #93A1A1">,</span> <span style="color: #719e07">gamma</span><span style="color: #93A1A1">,</span> S0<span style="color: #93A1A1">,</span> I0<span style="color: #93A1A1">,</span> incidence <span style="color: #719e07">=</span> <span style="color: #CB4B16">TRUE</span><span style="color: #93A1A1">),</span> 
                          RK4SIR.Yang<span style="color: #93A1A1">(</span>n<span style="color: #93A1A1">,</span> <span style="color: #719e07">beta</span><span style="color: #93A1A1">,</span> <span style="color: #719e07">gamma</span><span style="color: #93A1A1">,</span> S0<span style="color: #93A1A1">,</span> I0<span style="color: #93A1A1">,</span> incidence <span style="color: #719e07">=</span> <span style="color: #CB4B16">TRUE</span><span style="color: #93A1A1">),</span> 
                          times <span style="color: #719e07">=</span> <span style="color: #2AA198">10</span><span style="color: #93A1A1">)</span>
<span style="color: #586E75"># change expr for plot</span>
compare<span style="color: #719e07">$</span>expr <span style="color: #719e07">&lt;-</span> <span style="color: #719e07">gsub</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">&quot;rk4(y0, times, SIR, params)&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;rk4&quot;</span><span style="color: #93A1A1">,</span> 
                     compare<span style="color: #719e07">$</span>expr<span style="color: #93A1A1">,</span> fixed <span style="color: #719e07">=</span> <span style="color: #CB4B16">TRUE</span><span style="color: #93A1A1">)</span>
compare<span style="color: #719e07">$</span>expr <span style="color: #719e07">&lt;-</span> <span style="color: #719e07">gsub</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">&quot;RK4SIR(n, beta, gamma, S0, I0, incidence = TRUE)&quot;</span><span style="color: #93A1A1">,</span> <span style="color: #2AA198">&quot;RK4SIR&quot;</span><span style="color: #93A1A1">,</span> 
                     compare<span style="color: #719e07">$</span>expr<span style="color: #93A1A1">,</span> fixed <span style="color: #719e07">=</span> <span style="color: #CB4B16">TRUE</span><span style="color: #93A1A1">)</span>
compare<span style="color: #719e07">$</span>expr <span style="color: #719e07">&lt;-</span> <span style="color: #719e07">gsub</span><span style="color: #93A1A1">(</span><span style="color: #2AA198">&quot;RK4SIR.Yang(n, beta, gamma, S0, I0, incidence = TRUE)&quot;</span><span style="color: #93A1A1">,</span> 
                     <span style="color: #2AA198">&quot;RK4SIR.Yang&quot;</span><span style="color: #93A1A1">,</span> compare<span style="color: #719e07">$</span>expr<span style="color: #93A1A1">,</span> fixed <span style="color: #719e07">=</span> <span style="color: #CB4B16">TRUE</span><span style="color: #93A1A1">)</span>
compare
</pre></div>

<pre><code>## Unit: milliseconds
##         expr       min        lq      mean    median        uq       max
##          rk4 26.633415 26.808269 31.203988 27.158211 29.086869 63.952667
##       RK4SIR  3.767904  4.084908  4.628463  4.308558  5.080188  6.447710
##  RK4SIR.Yang  4.590251  4.771556  5.317731  4.902217  4.985512  8.661047
##  neval
##     10
##     10
##     10
</code></pre>

<p>Draw a comparison of distribution times.</p>
<div class="highlight" style="background: #002B36"><pre style="line-height: 125%"><span></span>p <span style="color: #719e07">&lt;-</span> autoplot<span style="color: #93A1A1">(</span>compare<span style="color: #93A1A1">)</span>
p <span style="color: #719e07">+</span> geom_violin<span style="color: #93A1A1">(</span>aes<span style="color: #93A1A1">(</span>color <span style="color: #719e07">=</span> expr<span style="color: #93A1A1">,</span> fill <span style="color: #719e07">=</span> expr<span style="color: #93A1A1">))</span> <span style="color: #719e07">+</span> 
  theme<span style="color: #93A1A1">(</span>legend.position <span style="color: #719e07">=</span> <span style="color: #2AA198">&quot;none&quot;</span><span style="color: #93A1A1">)</span>
</pre></div>

<p><img src="http://tonytsai.name/materials/RK4SIR_files/figure-html/unnamed-chunk-20-1.png" alt="" /></p>

<p><code>rk4</code> function from <code>deSolve</code> package runs much slower than both <code>RK4SIR</code> and <code>RK4SIR.Yang</code> fucntions as it takes much time to spin up for calling external <code>FORTRAN</code> or <code>C</code> functions. Though <code>RK4SIR</code> function performs the extra calculation of incidence, the benchmarking results show that <code>RK4SIR</code> function still runs faster than <code>RK4SIR.Yang</code> function. This is because <code>RK4SIR.Yang</code> function calculates cummulative incidence one by one per iterative formula while <code>RK4SIR</code> function directly apply <code>diff</code> function to the resulting vector <code>S</code> to accomplish the calculation. <code>diff</code> function is a vector operation and takes much less time.</p>

        </div>
        

<footer>
  <p class="meta">
    <span class="byline author vcard">Posted by <span class="fn">Tony Tsai</span></span>
    
    <time>Nov 24, 2014</time>
    
      <span class="categories">
        Tags:
        
          <a class="category" href="http://blog.tonytsai.name/tags/rk4">RK4</a>  <a class="category" href="http://blog.tonytsai.name/tags/sir">SIR</a>  <a class="category" href="http://blog.tonytsai.name/tags/incidence">Incidence</a>  <a class="category" href="http://blog.tonytsai.name/tags/benchmark">Benchmark</a>  
    
    </span>
  </p>

  
  

  

  <p class="meta">
    
        <a class="basic-alignment left" href="http://blog.tonytsai.name/blog/2014-09-30-problems-with-adduser-on-ubuntu-and-solutions/" title="Problems with adduser on Ubuntu and Solutions">Problems with adduser on Ubuntu and Solutions</a>
    

    
      <a class="basic-alignment right" href="http://blog.tonytsai.name/blog/2014-11-24-precision-difference-of-ode45-between-r-and-matlab/" title="Precision Difference of ode45 between R and MATLAB">Precision Difference of ode45 between R and MATLAB</a>
    
  </p>
  
    
      <div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    
    

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'tonytsai';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
 
    
  
  
</footer>

      </article>
    </div>
    

<aside class="sidebar thirds">
  <section class="first odd">

    
      <h1>Who am I</h1>
    

    <p>
      
        I am Jun (Tony) Cai (Tsai). A Ph.D. candidate interested in influenza transmission dynamics at Department of Earth System Science, Tsinghua University.
    </br>
    View my profile in <a href="https://scholar.google.com/citations?user=_dV_jnkAAAAJ" target="_blank">Google Scholar</a>.
      
    </p>
  </section>



  
  <ul class="sidebar-nav">
    <li class="sidebar-nav-item">
      <a target="_blank" href="https://github.com/caijun/" title="https://github.com/caijun/"><i class="fa fa-github fa-3x"></i></a>
      
      
      <a target="_blank" href="https://twitter.com/caijun2046/" title="https://twitter.com/caijun2046/"><i class="fa fa-twitter fa-3x"></i></a>
       
      
      
      
      <a target="_blank" href="https://www.facebook.com/tony.tsai.007/" title="https://www.facebook.com/tony.tsai.007/"><i class="fa fa-facebook fa-3x"></i></a>
      
      
      <a target="_blank" href="http://weibo.com/caijun2046/" title="http://weibo.com/caijun2046/"><i class="fa fa-weibo fa-3x"></i></a>

    
    
    </li>
  </ul>

  

  

  
  
  
    
      <section class="even">
        <h1>Recent Posts</h1>
        <ul id="recent_posts">
          
            <li class="post">
              <a href="/blog/2017-01-05-test-mathjax/">Test MathJax</a>
            </li>
          
            <li class="post">
              <a href="/blog/2015-08-09-optimization-of-disk-usage-for-animint/">Optimization of Disk Usage for animint</a>
            </li>
          
            <li class="post">
              <a href="/blog/2015-05-21-operator-for-extracting-named-list-elements-to-variables/">Operator for Extracting Named List Elements to Variables</a>
            </li>
          
            <li class="post">
              <a href="/blog/2015-05-10-resources-for-influenza-research/">Resources for Influenza Research</a>
            </li>
          
            <li class="post">
              <a href="/blog/2015-04-23-why-does-the-jackknife-estimate-of-standard-error-have-the-factor-n-1/n/">Why Does the Jackknife Estimate of Standard Error Have the Factor (n-1)/n?</a>
            </li>
          
        </ul>
      </section>
    
  
  
  <section class="even">
    <h1>Books to Read</h1>
    <li><a href="https://www.amazon.com/Textbook-Influenza-Robert-G-Webster/dp/0470670487/">Textbook of Influenza</a></li>
    <li><a href="https://www.amazon.com/Infectious-Diseases-Humans-Dynamics-Publications/dp/019854040X">Infectious Diseases of Humans: Dynamics and Control</a></li>
    <li><a href="https://www.amazon.com/Modeling-Infectious-Diseases-Humans-Animals/dp/0691116172/">Modeling Infectious Diseases in Humans and Animals</a></li>
    <li><a href="https://www.amazon.com/Infectious-Disease-Epidemiology-Theory-Practice/dp/1449683797">Infectious Disease Epidemiology: Theory and Practice</a></li>
    <li><a href="https://www.amazon.com/Bayesian-Analysis-Chapman-Statistical-Science/dp/1439840954">Bayesian Data Analysis</a></li>
    <li><a href="https://www.amazon.com/Seamless-Integration-Rcpp-Dirk-Eddelbuettel/dp/1461468671">Seamless R and C++ Integration with Rcpp</a></li>

    <h1>Links</h1>
    <li><a href="http://www.repidemicsconsortium.org/">R Epidemics Consortium</a></li>
    <li><a href="http://r-bloggers.com/">R-bloggers</a></li>

    <h1>Friends</h1>
    <li><a href="https://xg1990.com/blog/">xg1990</a></li>
  </section>

  <script type="text/javascript" src="//ra.revolvermaps.com/0/0/8.js?i=0551xokm7cj&amp;m=0&amp;s=300&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33" async="async"></script>

</aside>

  </div>
</div>

<footer role="contentinfo">
  <p>Copyright &copy; 2017 Tony Tsai - <a href="http://blog.tonytsai.name/license/">License</a> -
  <span class="credit">Powered by <a target="_blank" href="https://gohugo.io">Hugo</a> and <a target="_blank" href="https://github.com/parsiya/hugo-octopress/">Hugo-Octopress</a> theme.
</p>

</footer>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] },
  tex2jax: {
    inlineMath: [['$','$']],
    displayMath: [['$$','$$']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
  }
});
</script>
<script type="text/javascript"
  src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<script>
  var _gaq=[['_setAccount','UA-40665800-1'],['_trackPageview']];
  (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
  g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
  s.parentNode.insertBefore(g,s)}(document,'script'));
</script>

</body>
</html>

